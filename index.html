<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot School Dashboard V3</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            blue: '#1E51A2',
                            orange: '#F3981E',
                            white: '#FFFFFF',
                            slate: '#F8FAFC'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "recharts": "https://esm.sh/recharts@2.12.7?external=react,react-dom",
            "lucide-react": "https://esm.sh/lucide-react@0.395.0?external=react,react-dom",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js"
        }
    }
    </script>

    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #F8FAFC; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #1E51A2; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect, useRef } from "react";
        import { createRoot } from "react-dom/client";
        import { BarChart, Bar, AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from "recharts";
        import { 
            LayoutDashboard, Users, TrendingUp, Calendar, DollarSign, Activity, Loader2, 
            Settings, Plus, Trash2, School, FileText, Save, Sun, Cloud, CloudRain, Snowflake, Ban, PenTool, 
            ChevronRight, Upload, FileSpreadsheet, LogOut, ArrowRight
        } from "lucide-react";
        import { initializeApp } from "firebase/app";
        import { getFirestore, collection, doc, setDoc, getDocs, query, orderBy, serverTimestamp, writeBatch } from "firebase/firestore";

        // ==========================================
        // 1. Firebase Config & Utilities
        // ==========================================
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCsgMN0SWCC1SvCDIakYBejTWlxwBmiwJk",
            authDomain: "robodone-dashboard.firebaseapp.com",
            projectId: "robodone-dashboard",
            storageBucket: "robodone-dashboard.firebasestorage.app",
            messagingSenderId: "457095919160",
            appId: "1:457095919160:web:1716af87290b63733598cd"
        };

        let db = null;
        let isFirebaseInitialized = false;
        try {
            if (FIREBASE_CONFIG.apiKey) {
                const app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                isFirebaseInitialized = true;
            }
        } catch (e) { console.error("Firebase Init Error:", e); }

        const MONTHS_LIST = ['4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月', '1月', '2月', '3月'];
        const YEARS_LIST = [2022, 2023, 2024, 2025, 2026];

        const formatYen = (val) => `¥${Number(val).toLocaleString()}`;
        const parseDate = (dateValue) => {
            if (!dateValue) return null;
            if (dateValue && typeof dateValue.toDate === 'function') return dateValue.toDate();
            if (dateValue && dateValue.seconds) return new Date(dateValue.seconds * 1000);
            return new Date(dateValue);
        };
        const formatDateStr = (date) => {
            const y = date.getFullYear();
            const m = ('0' + (date.getMonth() + 1)).slice(-2);
            const d = ('0' + date.getDate()).slice(-2);
            return `${y}-${m}-${d}`;
        };
        const getFiscalYear = (date) => (date.getMonth() < 3 ? date.getFullYear() - 1 : date.getFullYear());
        const normalizeString = (str) => (!str ? "" : str.replace(/[\s\u3000]/g, "").replace(/[Ａ-Ｚａ-ｚ０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)));

        // ==========================================
        // 2. Data Processing Logic (Ported from V2)
        // ==========================================
        const processDashboardData = (campuses, enrollments, statusChanges, transfers, dailyReports, financials, targetYear) => {
            const sheetNameToIdMap = {};
            campuses.forEach(c => {
                const key = c.sheetName || c.name;
                sheetNameToIdMap[key] = c.id;
                sheetNameToIdMap[normalizeString(key)] = c.id;
            });

            // Helper to resolve campus ID from string
            const resolveCampusId = (name) => sheetNameToIdMap[name] || sheetNameToIdMap[normalizeString(name)];

            // Initialize Monthly Data Structure
            const monthlyStats = MONTHS_LIST.map(m => ({
                name: m,
                revenue: 0,
                students: 0,
                newEnrollments: 0,
                withdrawals: 0
            }));

            // 1. Calculate Base Student Count (Before Target Year)
            let baseStudentCount = 0;
            const countBefore = (list, typeFilter = null) => {
                let count = 0;
                list.forEach(item => {
                    const d = parseDate(item.date);
                    if (!d || getFiscalYear(d) >= targetYear) return;
                    if (typeFilter && (!item.type || !item.type.includes(typeFilter))) return;
                    count++;
                });
                return count;
            };
            const prevEnroll = countBefore(enrollments);
            const prevTransferIn = countBefore(transfers); // Assume transfers are ins
            const prevWithdraw = countBefore(statusChanges, "退会");
            const prevGrad = countBefore(statusChanges, "卒業");
            const prevTransferOut = countBefore(statusChanges, "転校");
            
            baseStudentCount = (prevEnroll + prevTransferIn) - (prevWithdraw + prevGrad + prevTransferOut);

            // 2. Iterate Months to build trend
            let currentStudents = baseStudentCount;

            monthlyStats.forEach((stat, idx) => {
                let targetMonthYear = targetYear;
                let jsMonth = idx + 3; // 0=Apr
                if (jsMonth > 11) { jsMonth -= 12; targetMonthYear++; }
                
                // Count events in this month
                const filterInMonth = (list, typeFilter = null) => list.filter(item => {
                    const d = parseDate(item.date);
                    if (!d) return false;
                    if (typeFilter && (!item.type || !item.type.includes(typeFilter))) return false;
                    return d.getFullYear() === targetMonthYear && d.getMonth() === jsMonth;
                }).length;

                const mEnroll = filterInMonth(enrollments);
                const mTransferIn = filterInMonth(transfers);
                const mWithdraw = filterInMonth(statusChanges, "退会");
                const mGrad = filterInMonth(statusChanges, "卒業");
                const mTransferOut = filterInMonth(statusChanges, "転校");
                const mReturn = filterInMonth(statusChanges, "復会");

                const netChange = (mEnroll + mTransferIn + mReturn) - (mWithdraw + mGrad + mTransferOut);
                currentStudents += netChange;

                stat.students = currentStudents;
                stat.newEnrollments = mEnroll;
                stat.withdrawals = mWithdraw;

                // Revenue Aggregation from Financials
                // Financials are expected to be { date, amount, type/category, campusId }
                const monthRevenue = financials.reduce((sum, fin) => {
                    const d = parseDate(fin.date); // CSV date string or timestamp
                    if (!d) return sum;
                    if (d.getFullYear() === targetMonthYear && d.getMonth() === jsMonth) {
                        return sum + (Number(fin.amount) || 0);
                    }
                    return sum;
                }, 0);
                stat.revenue = monthRevenue;
            });

            return monthlyStats;
        };

        // ==========================================
        // 3. UI Components
        // ==========================================
        const StatCard = ({ title, value, subValue, icon: Icon, colorClass }) => (
            <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-l-transparent hover:border-l-brand-orange transition-all duration-200 group">
                <div className="flex justify-between items-start">
                    <div>
                        <p className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">{title}</p>
                        <h3 className="text-2xl font-bold text-gray-800 group-hover:text-brand-blue transition-colors">{value}</h3>
                    </div>
                    <div className={`p-3 rounded-full bg-gray-50 group-hover:bg-brand-blue/10 transition-colors`}>
                        <Icon className={`w-6 h-6 ${colorClass || 'text-brand-blue'}`} />
                    </div>
                </div>
                {subValue && <div className="mt-4 flex items-center text-sm"><span className="text-gray-400 font-medium">{subValue}</span></div>}
            </div>
        );

        const CsvUploader = ({ onUpload, isUploading }) => {
            const fileInputRef = useRef(null);
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => parseCSV(event.target.result);
                reader.readAsText(file);
            };
            const parseCSV = (text) => {
                const lines = text.split(/\r\n|\n/);
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    const cols = line.split(',');
                    if (cols.length >= 3) {
                        data.push({
                            date: cols[0].trim(), // YYYY-MM-DD
                            category: cols[1].trim(),
                            amount: Number(cols[2].trim()) || 0,
                            description: cols[3] ? cols[3].trim() : ''
                        });
                    }
                }
                onUpload(data);
                if (fileInputRef.current) fileInputRef.current.value = "";
            };
            return (
                <div className="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:bg-gray-50 transition-colors cursor-pointer group" onClick={() => fileInputRef.current?.click()}>
                    <input type="file" accept=".csv" ref={fileInputRef} className="hidden" onChange={handleFileChange} />
                    <div className="w-16 h-16 bg-blue-50 text-brand-blue rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                        {isUploading ? <Loader2 className="w-8 h-8 animate-spin" /> : <Upload className="w-8 h-8" />}
                    </div>
                    <h3 className="text-lg font-bold text-gray-700 mb-1">CSVファイルをアップロード</h3>
                    <p className="text-sm text-gray-400">形式: 日付,科目,金額,摘要</p>
                </div>
            );
        };

        // ==========================================
        // 4. Main App & Consoles
        // ==========================================
        function App() {
            const [consoleMode, setConsoleMode] = useState('select'); 
            const [selectedCampusId, setSelectedCampusId] = useState(null);
            const [campusList, setCampusList] = useState([]);
            const [selectedYear, setSelectedYear] = useState(2024);
            
            // Global Data State
            const [allData, setAllData] = useState({
                enrollments: [],
                statusChanges: [],
                transfers: [],
                dailyReports: [],
                financials: []
            });

            // Fetch Data
            const fetchData = async () => {
                if (!isFirebaseInitialized) return;
                try {
                    const [campuses, enroll, status, trans, reports, finance] = await Promise.all([
                        getDocs(query(collection(db, "campuses"), orderBy("createdAt"))),
                        getDocs(collection(db, "enrollments")),
                        getDocs(collection(db, "status_changes")),
                        getDocs(collection(db, "transfers")),
                        getDocs(collection(db, "daily_reports")),
                        getDocs(collection(db, "financials"))
                    ]);

                    setCampusList(campuses.docs.map(d => ({ id: d.id, ...d.data() })));
                    setAllData({
                        enrollments: enroll.docs.map(d => ({id:d.id, ...d.data()})),
                        statusChanges: status.docs.map(d => ({id:d.id, ...d.data()})),
                        transfers: trans.docs.map(d => ({id:d.id, ...d.data()})),
                        dailyReports: reports.docs.map(d => ({id:d.id, ...d.data()})),
                        financials: finance.docs.map(d => ({id:d.id, ...d.data()}))
                    });
                } catch (e) { console.error("Fetch Error:", e); }
            };

            useEffect(() => { fetchData(); }, []);

            const handleEnterHQ = () => setConsoleMode('hq');
            const handleEnterSchool = (id) => { setSelectedCampusId(id); setConsoleMode('school'); };
            const handleBack = () => { setConsoleMode('select'); setSelectedCampusId(null); };

            // Render Modes
            if (consoleMode === 'select') {
                return (
                    <div className="min-h-screen bg-brand-slate flex items-center justify-center p-6 fade-in">
                        <div className="max-w-4xl w-full">
                            <div className="text-center mb-12">
                                <h1 className="text-4xl font-bold text-brand-blue mb-4 tracking-tight">Robot School Dashboard V3</h1>
                                <p className="text-gray-500">管理コンソールを選択してください</p>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div onClick={handleEnterHQ} className="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-xl hover:border-brand-blue/30 transition-all group relative overflow-hidden">
                                    <div className="absolute top-0 right-0 w-32 h-32 bg-brand-blue/5 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                                    <div className="relative z-10">
                                        <div className="w-16 h-16 bg-brand-blue rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-brand-blue/20">
                                            <LayoutDashboard className="w-8 h-8 text-white" />
                                        </div>
                                        <h2 className="text-2xl font-bold text-gray-800 mb-2">本部コンソール</h2>
                                        <p className="text-sm text-gray-500 mb-6">全校データの閲覧・管理</p>
                                        <span className="inline-flex items-center text-brand-blue font-bold text-sm group-hover:translate-x-1 transition-transform">ログイン <ArrowRight className="ml-2 w-4 h-4" /></span>
                                    </div>
                                </div>
                                <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden">
                                    <div className="absolute top-0 right-0 w-32 h-32 bg-brand-orange/5 rounded-bl-full -mr-8 -mt-8"></div>
                                    <div className="relative z-10">
                                        <div className="w-16 h-16 bg-brand-orange rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-brand-orange/20">
                                            <School className="w-8 h-8 text-white" />
                                        </div>
                                        <h2 className="text-2xl font-bold text-gray-800 mb-2">校舎コンソール</h2>
                                        <p className="text-sm text-gray-500 mb-6">日報・計画・収支入力</p>
                                        <div className="mt-4 space-y-2 max-h-48 overflow-y-auto pr-2">
                                            {campusList.map(c => (
                                                <button key={c.id} onClick={() => handleEnterSchool(c.id)} className="w-full text-left px-4 py-3 rounded-lg border border-gray-100 hover:border-brand-orange hover:bg-orange-50 transition-colors flex items-center justify-between group">
                                                    <span className="font-bold text-gray-700 group-hover:text-brand-orange">{c.name}</span>
                                                    <ChevronRight className="w-4 h-4 text-gray-300 group-hover:text-brand-orange" />
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (consoleMode === 'hq') {
                return <HQConsole onBack={handleBack} campusList={campusList} allData={allData} selectedYear={selectedYear} setSelectedYear={setSelectedYear} refreshData={fetchData} />;
            }
            if (consoleMode === 'school') {
                const targetCampus = campusList.find(c => c.id === selectedCampusId);
                return <SchoolConsole onBack={handleBack} campus={targetCampus} allData={allData} selectedYear={selectedYear} setSelectedYear={setSelectedYear} refreshData={fetchData} />;
            }
            return null;
        }

        // ==========================================
        // 5. HQ Console
        // ==========================================
        function HQConsole({ onBack, campusList, allData, selectedYear, setSelectedYear, refreshData }) {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [newCampusName, setNewCampusName] = useState("");
            const [newCampusId, setNewCampusId] = useState("");

            // Aggregate Data for HQ
            const dashboardData = useMemo(() => {
                return processDashboardData(
                    campusList, 
                    allData.enrollments, 
                    allData.statusChanges, 
                    allData.transfers, 
                    allData.dailyReports, 
                    allData.financials,
                    Number(selectedYear)
                );
            }, [allData, campusList, selectedYear]);

            const totals = useMemo(() => {
                return dashboardData.reduce((acc, curr) => ({
                    revenue: acc.revenue + curr.revenue,
                    newEnrollments: acc.newEnrollments + curr.newEnrollments,
                    withdrawals: acc.withdrawals + curr.withdrawals
                }), { revenue: 0, newEnrollments: 0, withdrawals: 0 });
            }, [dashboardData]);
            
            const currentTotalStudents = dashboardData[dashboardData.length - 1]?.students || 0;

            const handleAddCampus = async () => {
                if (!newCampusId || !newCampusName) return alert("必須項目が空です");
                try {
                    await setDoc(doc(db, "campuses", newCampusId), { id: newCampusId, name: newCampusName, createdAt: serverTimestamp() });
                    setNewCampusId(""); setNewCampusName("");
                    refreshData();
                    alert("校舎を追加しました");
                } catch(e) { alert("エラー: " + e.message); }
            };

            return (
                <div className="flex h-screen bg-brand-slate overflow-hidden fade-in">
                    <aside className="w-64 bg-white border-r border-gray-200 flex flex-col z-10">
                        <div className="p-6 border-b border-gray-100 flex items-center space-x-3">
                            <div className="w-8 h-8 bg-brand-blue rounded flex items-center justify-center"><LayoutDashboard className="w-5 h-5 text-white" /></div>
                            <span className="font-bold text-lg text-gray-800">本部コンソール</span>
                        </div>
                        <nav className="flex-1 p-4 space-y-1">
                            {[{id:'dashboard',l:'ダッシュボード',i:Activity}, {id:'settings',l:'校舎管理',i:Settings}].map(t => (
                                <button key={t.id} onClick={() => setActiveTab(t.id)} className={`w-full flex items-center px-4 py-3 rounded-lg transition-colors ${activeTab === t.id ? 'bg-brand-blue text-white shadow-md shadow-brand-blue/30' : 'text-gray-500 hover:bg-gray-50'}`}>
                                    <t.i className="w-5 h-5 mr-3" />{t.l}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-gray-100"><button onClick={onBack} className="flex items-center text-gray-400 hover:text-gray-600 text-sm w-full px-4 py-2"><LogOut className="w-4 h-4 mr-2" /> 戻る</button></div>
                    </aside>
                    <main className="flex-1 overflow-y-auto">
                        <header className="bg-white h-16 border-b border-gray-200 flex items-center justify-between px-8 sticky top-0 z-20">
                            <h2 className="text-xl font-bold text-gray-800">{activeTab==='dashboard'?'全校サマリー':'校舎管理'}</h2>
                            <div className="flex items-center space-x-4">
                                <select value={selectedYear} onChange={(e)=>setSelectedYear(e.target.value)} className="bg-gray-50 border border-gray-200 rounded-lg px-3 py-1.5 text-sm font-bold text-gray-600 focus:ring-2 focus:ring-brand-blue outline-none">
                                    {YEARS_LIST.map(y => <option key={y} value={y}>{y}年度</option>)}
                                </select>
                                <div className="w-8 h-8 rounded-full bg-brand-orange flex items-center justify-center text-white font-bold text-xs">HQ</div>
                            </div>
                        </header>
                        <div className="p-8 max-w-7xl mx-auto">
                            {activeTab === 'dashboard' && (
                                <div className="space-y-8">
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                        <StatCard title="年間売上 (CSV集計)" value={formatYen(totals.revenue)} subValue="アップロード済データ計" icon={DollarSign} colorClass="text-brand-blue" />
                                        <StatCard title="現在在籍数" value={`${currentTotalStudents}名`} subValue="推移末尾" icon={Users} colorClass="text-brand-orange" />
                                        <StatCard title="年間入会" value={`${totals.newEnrollments}名`} subValue="累計" icon={TrendingUp} colorClass="text-emerald-500" />
                                        <StatCard title="年間退会" value={`${totals.withdrawals}名`} subValue="累計" icon={TrendingUp} colorClass="text-rose-500" />
                                    </div>
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-80">
                                            <h3 className="text-lg font-bold text-gray-800 mb-6 flex items-center"><DollarSign className="w-5 h-5 mr-2 text-brand-blue"/> 売上推移</h3>
                                            <ResponsiveContainer width="100%" height="90%">
                                                <AreaChart data={dashboardData}><defs><linearGradient id="colorRev" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#1E51A2" stopOpacity={0.8}/><stop offset="95%" stopColor="#1E51A2" stopOpacity={0}/></linearGradient></defs><CartesianGrid strokeDasharray="3 3" vertical={false}/><XAxis dataKey="name"/><YAxis/><Tooltip formatter={(value)=>formatYen(value)}/><Area type="monotone" dataKey="revenue" stroke="#1E51A2" fillOpacity={1} fill="url(#colorRev)"/></AreaChart>
                                            </ResponsiveContainer>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-80">
                                            <h3 className="text-lg font-bold text-gray-800 mb-6 flex items-center"><Users className="w-5 h-5 mr-2 text-brand-orange"/> 生徒数推移</h3>
                                            <ResponsiveContainer width="100%" height="90%">
                                                <BarChart data={dashboardData}><CartesianGrid strokeDasharray="3 3" vertical={false}/><XAxis dataKey="name"/><YAxis/><Tooltip/><Bar dataKey="students" fill="#F3981E" radius={[4,4,0,0]}/></BarChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>
                                </div>
                            )}
                            {activeTab === 'settings' && (
                                <div className="space-y-8">
                                    <div className="bg-white p-8 rounded-xl shadow-sm border border-gray-100">
                                        <h3 className="text-lg font-bold text-gray-800 mb-6 flex items-center"><Plus className="w-5 h-5 mr-2 text-brand-blue"/> 新規校舎登録</h3>
                                        <div className="flex gap-4 items-end">
                                            <div className="flex-1"><label className="block text-sm font-bold text-gray-700 mb-2">ID</label><input type="text" value={newCampusId} onChange={e=>setNewCampusId(e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-brand-blue" placeholder="shibuya"/></div>
                                            <div className="flex-1"><label className="block text-sm font-bold text-gray-700 mb-2">校舎名</label><input type="text" value={newCampusName} onChange={e=>setNewCampusName(e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-brand-blue" placeholder="渋谷校"/></div>
                                            <button onClick={handleAddCampus} className="bg-brand-blue text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700">登録</button>
                                        </div>
                                    </div>
                                    <div className="bg-white p-8 rounded-xl shadow-sm border border-gray-100">
                                        <h3 className="text-lg font-bold text-gray-800 mb-6">登録済み校舎 ({campusList.length})</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{campusList.map(c=><div key={c.id} className="p-4 border border-gray-200 rounded-lg bg-gray-50 flex justify-between"><div><div className="font-bold text-gray-700">{c.name}</div><div className="text-xs text-gray-400">{c.id}</div></div><div className="w-2 h-2 rounded-full bg-emerald-400"></div></div>)}</div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        // ==========================================
        // 6. School Console
        // ==========================================
        function SchoolConsole({ onBack, campus, allData, selectedYear, setSelectedYear, refreshData }) {
            const [activeTab, setActiveTab] = useState('daily');
            const [selectedMonth, setSelectedMonth] = useState('4月');
            const [reportDate, setReportDate] = useState(formatDateStr(new Date()));
            const [inputData, setInputData] = useState({ weather: 'sunny', flyers: 0, touch: 0, trial: 0 });
            const [uploading, setUploading] = useState(false);

            // Fetch existing daily report when date changes
            useEffect(() => {
                if (!campus) return;
                const existing = allData.dailyReports.find(r => r.campusId === campus.id && r.date === reportDate);
                if (existing) {
                    setInputData({
                        weather: existing.weather || 'sunny',
                        flyers: existing.flyers || 0,
                        touch: existing.touchTry || 0,
                        trial: existing.trialLessons || 0
                    });
                } else {
                    setInputData({ weather: 'sunny', flyers: 0, touch: 0, trial: 0 });
                }
            }, [reportDate, allData.dailyReports, campus]);

            const handleSaveReport = async () => {
                if (!campus) return;
                try {
                    await setDoc(doc(db, "daily_reports", `${campus.id}_${reportDate}`), {
                        campusId: campus.id,
                        date: reportDate,
                        weather: inputData.weather,
                        flyers: Number(inputData.flyers),
                        touchTry: Number(inputData.touch),
                        trialLessons: Number(inputData.trial),
                        updatedAt: serverTimestamp()
                    });
                    refreshData();
                    alert("保存しました");
                } catch(e) { alert("エラー: " + e.message); }
            };

            const handleCsvUpload = async (data) => {
                if (!campus) return;
                setUploading(true);
                try {
                    const batch = writeBatch(db);
                    data.forEach(item => {
                        const ref = doc(collection(db, "financials"));
                        batch.set(ref, { ...item, campusId: campus.id, createdAt: serverTimestamp() });
                    });
                    await batch.commit();
                    refreshData();
                    alert(`${data.length}件のデータを取り込みました`);
                } catch (e) { alert("エラー: " + e.message); } finally { setUploading(false); }
            };

            if (!campus) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-brand-blue"/></div>;

            const weatherMap = { sunny: {i:Sun,l:'晴',c:'text-orange-500'}, cloudy: {i:Cloud,l:'曇',c:'text-gray-500'}, rainy: {i:CloudRain,l:'雨',c:'text-blue-500'}, snowy: {i:Snowflake,l:'雪',c:'text-cyan-500'}, closed: {i:Ban,l:'休',c:'text-red-500'} };

            return (
                <div className="flex h-screen bg-brand-slate overflow-hidden fade-in">
                    <aside className="w-64 bg-white border-r border-gray-200 flex flex-col z-10">
                        <div className="p-6 border-b border-gray-100">
                            <div className="flex items-center space-x-2 mb-1"><School className="w-5 h-5 text-brand-orange" /><span className="font-bold text-sm text-brand-orange">校舎コンソール</span></div>
                            <h2 className="text-xl font-bold text-gray-800 truncate">{campus.name}</h2>
                        </div>
                        <nav className="flex-1 p-4 space-y-1">
                            {[{id:'daily',l:'日報入力',i:Calendar}, {id:'plan',l:'計画策定',i:FileText}, {id:'finance',l:'収支取込',i:FileSpreadsheet}].map(t => (
                                <button key={t.id} onClick={() => setActiveTab(t.id)} className={`w-full flex items-center px-4 py-3 rounded-lg transition-colors ${activeTab === t.id ? 'bg-brand-orange text-white shadow-md shadow-brand-orange/30' : 'text-gray-500 hover:bg-gray-50'}`}>
                                    <t.i className="w-5 h-5 mr-3" />{t.l}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-gray-100"><button onClick={onBack} className="flex items-center text-gray-400 hover:text-gray-600 text-sm w-full px-4 py-2"><LogOut className="w-4 h-4 mr-2" /> 戻る</button></div>
                    </aside>
                    <main className="flex-1 overflow-y-auto">
                        <header className="bg-white h-16 border-b border-gray-200 flex items-center justify-between px-8 sticky top-0 z-20">
                            <h2 className="text-xl font-bold text-gray-800">{{daily:'日報管理', plan:'計画策定', finance:'収支管理'}[activeTab]}</h2>
                            <div className="flex items-center space-x-4">
                                <select value={selectedYear} onChange={(e)=>setSelectedYear(e.target.value)} className="bg-gray-50 border border-gray-200 rounded-lg px-3 py-1.5 text-sm font-bold text-gray-600 focus:ring-2 focus:ring-brand-orange outline-none">
                                    {YEARS_LIST.map(y => <option key={y} value={y}>{y}年度</option>)}
                                </select>
                                <div className="w-8 h-8 rounded-full bg-brand-blue flex items-center justify-center text-white font-bold text-xs">SC</div>
                            </div>
                        </header>
                        <div className="p-8 max-w-5xl mx-auto">
                            {activeTab === 'daily' && (
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                    <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                                        <div className="flex justify-between mb-4">
                                            <h3 className="font-bold text-gray-700 flex items-center"><Calendar className="w-4 h-4 mr-2"/> {selectedYear}年 {selectedMonth}</h3>
                                            <div className="flex gap-1">{MONTHS_LIST.map(m=><button key={m} onClick={()=>setSelectedMonth(m)} className={`text-xs px-2 py-1 rounded ${selectedMonth===m?'bg-brand-orange text-white':'text-gray-400 hover:bg-gray-100'}`}>{m}</button>)}</div>
                                        </div>
                                        <div className="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200 rounded-lg overflow-hidden">
                                            {['日','月','火','水','木','金','土'].map((d,i)=><div key={i} className="bg-gray-50 text-center py-2 text-xs font-bold text-gray-500">{d}</div>)}
                                            {Array.from({length:31},(_,i)=>i+1).map(d=>{
                                                const dateStr = `${selectedYear}-${('0'+(MONTHS_LIST.indexOf(selectedMonth)+1)).slice(-2)}-${('0'+d).slice(-2)}`; 
                                                // Simplified date match logic for demo calendar
                                                const hasReport = allData.dailyReports.some(r => r.campusId === campus.id && r.date.endsWith(`-${('0'+d).slice(-2)}`) && r.date.includes((MONTHS_LIST.indexOf(selectedMonth)+4)%12 || 12));
                                                // Note: Exact date matching for calendar would require proper Date object logic. 
                                                // For this "Simple" calendar view, we just use the click handler to set full date.
                                                
                                                return (
                                                    <div key={d} onClick={()=>setReportDate(`${selectedYear}-${('0'+(MONTHS_LIST.indexOf(selectedMonth)+4)).slice(-2)}-${('0'+d).slice(-2)}`)} className="bg-white h-20 p-1 cursor-pointer hover:bg-blue-50 relative">
                                                        <span className="text-xs font-bold text-gray-700">{d}</span>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-fit">
                                        <h3 className="font-bold text-gray-800 mb-4 flex items-center"><PenTool className="w-4 h-4 mr-2 text-brand-orange"/> {reportDate}</h3>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="text-xs font-bold text-gray-400 block mb-2">天気</label>
                                                <div className="flex gap-2">{Object.entries(weatherMap).map(([k,v])=><button key={k} onClick={()=>setInputData({...inputData,weather:k})} className={`flex-1 py-2 rounded-lg border flex flex-col items-center justify-center ${inputData.weather===k?'bg-blue-50 border-brand-blue':'border-gray-100'}`}><v.i className={`w-4 h-4 mb-1 ${v.c}`}/><span className="text-[10px] font-bold text-gray-500">{v.l}</span></button>)}</div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div><label className="text-xs font-bold text-gray-400 block mb-1">門配数</label><input type="number" value={inputData.flyers} onChange={e=>setInputData({...inputData,flyers:e.target.value})} className="w-full border rounded p-2 text-right font-bold"/></div>
                                                <div><label className="text-xs font-bold text-gray-400 block mb-1">T&T数</label><input type="number" value={inputData.touch} onChange={e=>setInputData({...inputData,touch:e.target.value})} className="w-full border rounded p-2 text-right font-bold"/></div>
                                            </div>
                                            <div><label className="text-xs font-bold text-gray-400 block mb-1">体験会実施数</label><input type="number" value={inputData.trial} onChange={e=>setInputData({...inputData,trial:e.target.value})} className="w-full border rounded p-2 text-right font-bold"/></div>
                                            <button onClick={handleSaveReport} className="w-full bg-brand-orange text-white font-bold py-3 rounded-lg hover:bg-orange-600 flex items-center justify-center mt-4"><Save className="w-4 h-4 mr-2"/>保存</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                            {activeTab === 'finance' && (
                                <div className="space-y-8 bg-white p-8 rounded-xl shadow-sm border border-gray-100">
                                    <h3 className="text-lg font-bold text-gray-800 mb-6 flex items-center"><FileSpreadsheet className="w-5 h-5 mr-2 text-brand-orange"/> 収支CSV取込</h3>
                                    <div className="max-w-xl mx-auto"><CsvUploader onUpload={handleCsvUpload} isUploading={uploading}/></div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
